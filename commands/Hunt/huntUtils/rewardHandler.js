// rewardHandler.js

const { EmbedBuilder } = require('discord.js')
const { huntPages } = require('../huntPages')

function getRandomInt(max) {
  return Math.floor(Math.random() * max)
}

async function addRewardToUser(user, goldAmount = 0, tokenAmount = 0) {
  goldAmount = Number(goldAmount) || 0
  tokenAmount = Number(tokenAmount) || 0

  user.gold = (Number(user.gold) || 0) + goldAmount
  user.currency = {
    ...user.currency,
    tokens: (Number(user.currency.tokens) || 0) + tokenAmount,
  }

  console.log(
    `üí∞ Rewarding User ${user.user_id}: +${goldAmount} Gold, +${tokenAmount} Tokens`
  )
  await user.save()
}

async function displayHuntSummary(interaction, user, huntData, levelCompleted) {
  console.log('üèÜ Displaying Hunt Summary...')

  if (!huntData.level) {
    console.error(
      `‚ùå ERROR: huntData.level is undefined in displayHuntSummary.`
    )
    return interaction.followUp({
      content: 'Error: Invalid hunt data.',
      ephemeral: true,
    })
  }

  const pageKey = huntData.level.page
  const huntId = huntData.level.id

  if (!huntPages[pageKey]) {
    console.error(`‚ùå ERROR: huntPages[${pageKey}] is undefined!`)
    return interaction.followUp({
      content: `Error: Invalid hunt page (${pageKey}).`,
      ephemeral: true,
    })
  }

  const currentHunt = huntPages[pageKey].hunts.find(
    (hunt) => hunt.id === huntId
  )
  if (!currentHunt) {
    console.error(
      `‚ùå ERROR: Hunt data not found for ID ${huntId} on page ${pageKey}`
    )
    return interaction.followUp({
      content: 'Error: Hunt not found.',
      ephemeral: true,
    })
  }

  let totalGoldEarned = 0
  let totalTokensEarned = 0

  currentHunt.battles.forEach((battle) => {
    if (battle.type === 'mini-boss' && currentHunt.id > user.completedLevels) {
      totalGoldEarned += battle.firstGoldReward || battle.goldReward
    } else {
      totalGoldEarned += battle.goldReward
    }

    if (getRandomInt(3) === 0) {
      totalTokensEarned += 1
    }
  })

  await addRewardToUser(user, totalGoldEarned, totalTokensEarned)

  const summaryEmbed = new EmbedBuilder()
    .setTitle('Hunt Summary')
    .setDescription(
      `**Gold Earned:** ü™ô${totalGoldEarned}\n**Tokens Earned:** üßø${totalTokensEarned}`
    )
    .setColor('#FFD700')

  if (huntData.ichorUsed) {
    summaryEmbed.addFields({
      name: 'Ichor Invigoration',
      value: 'You used üß™ichor during this hunt, boosting your power!',
    })
  }

  if (levelCompleted) {
    console.log(
      '‚úî Hunt completed. Checking for next unlock...',
      'level id: ',
      huntData.level.id
    )

    if (huntData.level.id > user.completedLevels) {
      console.log(
        `üìà Increasing completedLevels from ${user.completedLevels} to ${huntData.level.id}`
      )
      user.completedLevels = huntData.level.id
      await user.save()
    }

    if (currentHunt.unlocks) {
      const nextHunt = huntPages[pageKey].hunts.find(
        (hunt) => hunt.key === currentHunt.unlocks
      )

      if (nextHunt && nextHunt.id > user.completedLevels) {
        console.log(`üîì Unlocking next hunt: ${nextHunt.name}`)

        user.completedLevels = nextHunt.id

        await user.save()

        summaryEmbed.spliceFields(0, 0, {
          name: 'Next Hunt Unlocked!',
          value: `You have unlocked **${nextHunt.name}**!`,
        })
      }
    }
    if (currentHunt.unlocksPage && huntPages[currentHunt.unlocksPage]) {
      summaryEmbed.addFields({
        name: 'New Hunt Page Unlocked!',
        value: `You have unlocked **${
          huntPages[currentHunt.unlocksPage].name
        }**!`,
      })
    }
  }

  summaryEmbed.setThumbnail(
    interaction.user.displayAvatarURL({ format: 'png', size: 128 })
  )

  try {
    await interaction.followUp({ embeds: [summaryEmbed], ephemeral: false })
    console.log(`‚úÖ Hunt summary successfully sent.`)
  } catch (error) {
    console.error('‚ùå Error sending hunt summary:', error)
  }
}

module.exports = { displayHuntSummary }
